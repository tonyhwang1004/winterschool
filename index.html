// =====================================================
// ìˆ˜ë¦¬ë”©ì–´í•™ì› Google Apps Script v6
// íšŒì› ìŠ¹ì¸ ì‹œìŠ¤í…œ + ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹ ì²­ (kmsongdo.store ì—°ë™)
// formType ê¸°ë°˜ ìë™ ë¶„ê¸° ì²˜ë¦¬
// =====================================================

const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();

// =====================================================
// GET ìš”ì²­ ì²˜ë¦¬
// =====================================================
function doGet(e) {
  const action = e.parameter.action;
  let result;
  
  try {
    switch(action) {
      case 'login':
        result = handleLogin(e.parameter.username, e.parameter.password);
        break;
      case 'signup':
        result = handleSignup(e.parameter);
        break;
      case 'getProgress':
        result = getProgress(e.parameter.username);
        break;
      case 'saveProgress':
        result = saveProgress(e.parameter);
        break;
      // ê´€ë¦¬ì ê¸°ëŠ¥
      case 'getPendingMembers':
        result = getPendingMembers();
        break;
      case 'getAllMembers':
        result = getAllMembers();
        break;
      case 'approveMember':
        result = approveMember(e.parameter.username);
        break;
      case 'rejectMember':
        result = rejectMember(e.parameter.username);
        break;
      // ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹ ì²­ ê´€ë¦¬
      case 'getLevelTestApplications':
        result = getLevelTestApplications();
        break;
      case 'markLevelTestChecked':
        result = markLevelTestChecked(e.parameter.row);
        break;
      case 'submitLevelTest':
        result = handleLevelTestSignup(e.parameter);
        break;
      default:
        result = { success: false, message: 'Unknown action' };
    }
  } catch (error) {
    result = { success: false, message: error.toString() };
  }
  
  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// =====================================================
// POST ìš”ì²­ ì²˜ë¦¬ (kmsongdo.store í¼ì—ì„œ ì „ì†¡)
// formType ê¸°ë°˜ìœ¼ë¡œ ìë™ ë¶„ê¸°
// =====================================================
function doPost(e) {
  let result;
  
  try {
    // JSON body íŒŒì‹±
    let jsonData = {};
    if (e.postData && e.postData.contents) {
      jsonData = JSON.parse(e.postData.contents);
    }
    
    // programs ë°°ì—´ì„ ë¬¸ìì—´ë¡œ ë³€í™˜
    if (jsonData.programs && Array.isArray(jsonData.programs)) {
      jsonData.programs = jsonData.programs.join(', ');
    }
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ action ê°€ì ¸ì˜¤ê¸° (ìˆìœ¼ë©´ ì‚¬ìš©)
    const action = e.parameter ? e.parameter.action : null;
    
    // actionì´ ìˆìœ¼ë©´ action ê¸°ë°˜, ì—†ìœ¼ë©´ formType ê¸°ë°˜ìœ¼ë¡œ ë¶„ê¸°
    if (action) {
      // ê¸°ì¡´ action ê¸°ë°˜ ì²˜ë¦¬
      switch(action) {
        case 'submitLevelTest':
          result = handleLevelTestSignup(jsonData);
          break;
        case 'submitStudent8f':
          result = handleStudentSignup8f(jsonData);
          break;
        case 'submitNsu7f':
          result = handleNsuSignup7f(jsonData);
          break;
        case 'signup':
          result = handleSignup(jsonData);
          break;
        default:
          result = { success: false, message: 'Unknown action: ' + action };
      }
    } else {
      // formType ê¸°ë°˜ ìë™ ë¶„ê¸° (kmsongdo.store í¼ìš©)
      const formType = jsonData.formType || '';
      
      switch(formType) {
        case 'ì¬í•™ìƒ':
          result = handleStudentSignup8f(jsonData);
          break;
        case 'Nìˆ˜ìƒ':
          result = handleNsuSignup7f(jsonData);
          break;
        case 'ì–´í•™ì›ìƒë‹´':
          result = handleLevelTestSignup(jsonData);
          break;
        default:
          // formTypeì´ ì—†ìœ¼ë©´ ë°ì´í„° ë‚´ìš©ìœ¼ë¡œ ì¶”ì¸¡
          if (jsonData.consultDate || jsonData.englishLevel) {
            result = handleLevelTestSignup(jsonData);
          } else if (jsonData.suneungScore || jsonData.highSchool) {
            result = handleNsuSignup7f(jsonData);
          } else {
            result = handleStudentSignup8f(jsonData);
          }
      }
    }
  } catch (error) {
    result = { success: false, message: error.toString() };
  }
  
  return ContentService
    .createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// =====================================================
// ë¡œê·¸ì¸ ì²˜ë¦¬
// =====================================================
function handleLogin(username, password) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('users');
  if (!sheet) {
    return { success: false, message: 'users ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
  }
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(username) && String(data[i][1]) === String(password)) {
      const status = data[i][10] || 'approved';
      
      return {
        success: true,
        user: {
          username: data[i][0],
          name: data[i][2],
          grade: data[i][3] || '',
          school: data[i][4] || '',
          level: data[i][7] || 1,
          is_admin: data[i][8],
          status: status
        }
      };
    }
  }
  
  return { success: false, message: 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤' };
}

// =====================================================
// íšŒì›ê°€ì… ì²˜ë¦¬ (ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœë¡œ ì €ì¥)
// =====================================================
function handleSignup(params) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('users');
  if (!sheet) {
    return { success: false, message: 'users ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
  }
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(params.username)) {
      return { success: false, message: 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤' };
    }
  }
  
  sheet.appendRow([
    String(params.username),
    String(params.password),
    params.name,
    params.grade || '',
    params.school || '',
    params.parentPhone || '',
    params.studentPhone || '',
    1,
    false,
    new Date(),
    'pending'
  ]);
  
  return { success: true, message: 'íšŒì›ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.' };
}

// =====================================================
// í•™ìŠµ ì§„ë„ ì €ì¥
// =====================================================
function saveProgress(params) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('progress');
  if (!sheet) {
    return { success: false, message: 'progress ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
  }
  
  const passed = params.score >= 80;
  sheet.appendRow([
    params.username,
    params.book_title,
    params.chapter,
    passed,
    params.score,
    new Date()
  ]);
  
  return { success: true, passed: passed, message: passed ? 'ğŸ‰ í†µê³¼!' : 'ğŸ˜¢ ë‹¤ì‹œ ë„ì „!' };
}

// =====================================================
// í•™ìŠµ ì§„ë„ ì¡°íšŒ
// =====================================================
function getProgress(username) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('progress');
  if (!sheet) {
    return { success: true, progress: [] };
  }
  
  const data = sheet.getDataRange().getValues();
  const progress = [];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === username) {
      progress.push({
        book_title: data[i][1],
        chapter: data[i][2],
        completed: data[i][3],
        score: data[i][4],
        completed_at: data[i][5]
      });
    }
  }
  
  return { success: true, progress: progress };
}

// =====================================================
// ê´€ë¦¬ì ê¸°ëŠ¥: ìŠ¹ì¸ ëŒ€ê¸° íšŒì› ëª©ë¡
// =====================================================
function getPendingMembers() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('users');
  if (!sheet) {
    return { success: true, members: [] };
  }
  
  const data = sheet.getDataRange().getValues();
  const members = [];
  
  for (let i = 1; i < data.length; i++) {
    const status = data[i][10] || 'approved';
    if (status === 'pending') {
      members.push({
        username: data[i][0],
        name: data[i][2],
        grade: data[i][3] || '',
        school: data[i][4] || '',
        parentPhone: data[i][5] || '',
        studentPhone: data[i][6] || '',
        level: data[i][7] || 1,
        status: status,
        created_at: data[i][9] || ''
      });
    }
  }
  
  return { success: true, members: members };
}

// =====================================================
// ê´€ë¦¬ì ê¸°ëŠ¥: ì „ì²´ íšŒì› ëª©ë¡
// =====================================================
function getAllMembers() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('users');
  if (!sheet) {
    return { success: true, members: [] };
  }
  
  const data = sheet.getDataRange().getValues();
  const members = [];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) {
      members.push({
        username: data[i][0],
        name: data[i][2],
        grade: data[i][3] || '',
        school: data[i][4] || '',
        parentPhone: data[i][5] || '',
        studentPhone: data[i][6] || '',
        level: data[i][7] || 1,
        is_admin: data[i][8],
        status: data[i][10] || 'approved',
        created_at: data[i][9] || ''
      });
    }
  }
  
  return { success: true, members: members };
}

// =====================================================
// ê´€ë¦¬ì ê¸°ëŠ¥: íšŒì› ìŠ¹ì¸
// =====================================================
function approveMember(username) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('users');
  if (!sheet) {
    return { success: false, message: 'users ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
  }
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === username) {
      sheet.getRange(i + 1, 11).setValue('approved');
      return { success: true, message: 'ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤' };
    }
  }
  
  return { success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
}

// =====================================================
// ê´€ë¦¬ì ê¸°ëŠ¥: íšŒì› ê±°ì ˆ/ì •ì§€
// =====================================================
function rejectMember(username) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('users');
  if (!sheet) {
    return { success: false, message: 'users ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
  }
  
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === username) {
      sheet.getRange(i + 1, 11).setValue('rejected');
      return { success: true, message: 'ê±°ì ˆ/ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤' };
    }
  }
  
  return { success: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
}

// =====================================================
// ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ
// =====================================================
function getLevelTestApplications() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('leveltest');
    
    if (!sheet) {
      return { success: true, applications: [] };
    }
    
    const data = sheet.getDataRange().getValues();
    const applications = [];
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0]) {
        applications.push({
          row: i + 1,
          timestamp: data[i][0] || '',
          studentName: data[i][1] || '',
          gender: data[i][2] || '',
          studentPhone: data[i][3] || '',
          parentPhone: data[i][4] || '',
          school: data[i][5] || '',
          grade: data[i][6] || '',
          preferredDateTime: data[i][7] || '',
          programs: data[i][8] || '',
          englishLevel: data[i][9] || '',
          inquiry: data[i][10] || '',
          paymentMethod: data[i][11] || '',
          status: data[i][12] || ''
        });
      }
    }
    
    applications.reverse();
    
    return { success: true, applications: applications };
  } catch (error) {
    return { success: false, message: error.toString(), applications: [] };
  }
}

// =====================================================
// ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹ ì²­ í™•ì¸ ì™„ë£Œ ì²˜ë¦¬
// =====================================================
function markLevelTestChecked(row) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('leveltest');
    sheet.getRange(parseInt(row), 13).setValue('checked');
    return { success: true, message: 'í™•ì¸ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤' };
  } catch (error) {
    return { success: false, message: error.toString() };
  }
}

// =====================================================
// ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹ ì²­ ì €ì¥ (ì–´í•™ì›ìƒë‹´)
// =====================================================
function handleLevelTestSignup(params) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName('leveltest');
    if (!sheet) {
      sheet = ss.insertSheet('leveltest');
      sheet.appendRow(['ì‹ ì²­ì¼ì‹œ', 'í•™ìƒì´ë¦„', 'ì„±ë³„', 'í•™ìƒì—°ë½ì²˜', 'ë¶€ëª¨ë‹˜ì—°ë½ì²˜', 'í•™êµ', 'í•™ë…„', 'í¬ë§ìƒë‹´ì¼ì‹œ', 'ê´€ì‹¬í”„ë¡œê·¸ë¨', 'ì˜ì–´ìˆ˜ì¤€', 'ë¬¸ì˜ì‚¬í•­', 'ê²°ì œë°©ë²•', 'í™•ì¸ìƒíƒœ']);
    }
    
    sheet.appendRow([
      new Date(),                    // A: ì‹ ì²­ì¼ì‹œ
      params.studentName || '',      // B: í•™ìƒì´ë¦„
      params.gender || '',           // C: ì„±ë³„
      params.studentPhone || '',     // D: í•™ìƒì—°ë½ì²˜
      params.parentPhone || '',      // E: ë¶€ëª¨ë‹˜ì—°ë½ì²˜
      params.school || '',           // F: í•™êµ
      params.grade || '',            // G: í•™ë…„
      params.consultDate || '',      // H: í¬ë§ìƒë‹´ì¼ì‹œ
      params.programs || '',         // I: ê´€ì‹¬í”„ë¡œê·¸ë¨
      params.englishLevel || '',     // J: ì˜ì–´ìˆ˜ì¤€
      params.inquiry || '',          // K: ë¬¸ì˜ì‚¬í•­
      params.paymentMethod || '',    // L: ê²°ì œë°©ë²•
      ''                             // M: í™•ì¸ìƒíƒœ
    ]);
    
    // ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
    sendEmailNotification('ë ˆë²¨í…ŒìŠ¤íŠ¸', params);
    
    return { success: true, message: 'ë ˆë²¨í…ŒìŠ¤íŠ¸ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' };
  } catch (error) {
    return { success: false, message: error.toString() };
  }
}

// =====================================================
// ì¬í•™ìƒ(8ì¸µ ë…ì„œì‹¤) ì‹ ì²­ ì²˜ë¦¬
// =====================================================
function handleStudentSignup8f(params) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName('student8f');
    if (!sheet) {
      sheet = ss.insertSheet('student8f');
      sheet.appendRow(['ì‹ ì²­ì¼ì‹œ', 'í•™ìƒì´ë¦„', 'ì„±ë³„', 'í•™ìƒì—°ë½ì²˜', 'ë¶€ëª¨ë‹˜ì—°ë½ì²˜', 'í•™êµ', 'í•™ë…„', 'í¬ë§ë“±ì›ì¼', 'ë‚´ì‹ ë“±ê¸‰', 'ì‚¬ì „ë“±ë¡í¬ë§', 'ê²°ì œë°©ë²•', 'í¡ì—°ì—¬ë¶€']);
    }
    
    sheet.appendRow([
      new Date(),                      // A: ì‹ ì²­ì¼ì‹œ
      params.studentName || '',        // B: í•™ìƒì´ë¦„
      params.gender || '',             // C: ì„±ë³„
      params.studentPhone || '',       // D: í•™ìƒì—°ë½ì²˜
      params.parentPhone || '',        // E: ë¶€ëª¨ë‹˜ì—°ë½ì²˜
      params.school || '',             // F: í•™êµ
      params.grade || '',              // G: í•™ë…„
      params.startDate || '',          // H: í¬ë§ë“±ì›ì¼
      params.gradeScore || '',         // I: ë‚´ì‹ ë“±ê¸‰
      params.preRegister || '',        // J: ì‚¬ì „ë“±ë¡í¬ë§
      params.paymentMethod || '',      // K: ê²°ì œë°©ë²•
      params.smoking8f || params.smoking || ''  // L: í¡ì—°ì—¬ë¶€
    ]);
    
    // ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
    sendEmailNotification('8ì¸µ ì¬í•™ìƒ(ë…ì„œì‹¤)', params);
    
    return { success: true, message: 'ëŒ€ê¸° ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' };
  } catch (error) {
    return { success: false, message: error.toString() };
  }
}

// =====================================================
// Nìˆ˜ìƒ(7ì¸µ ë…í•™ì¬ìˆ˜) ì‹ ì²­ ì²˜ë¦¬
// =====================================================
function handleNsuSignup7f(params) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName('nsu7f');
    if (!sheet) {
      sheet = ss.insertSheet('nsu7f');
      sheet.appendRow(['ì‹ ì²­ì¼ì‹œ', 'í•™ìƒì´ë¦„', 'ì„±ë³„', 'í•™ìƒì—°ë½ì²˜', 'ë¶€ëª¨ë‹˜ì—°ë½ì²˜', 'ì¶œì‹ ê³ ë“±í•™êµ', 'í¬ë§ë“±ì›ì¼', 'ìˆ˜ëŠ¥ë“±ê¸‰', 'ì‚¬ì „ë“±ë¡í¬ë§', 'ê²°ì œë°©ë²•', 'í¡ì—°ì—¬ë¶€']);
    }
    
    sheet.appendRow([
      new Date(),                      // A: ì‹ ì²­ì¼ì‹œ
      params.studentName || '',        // B: í•™ìƒì´ë¦„
      params.gender || '',             // C: ì„±ë³„
      params.studentPhone || '',       // D: í•™ìƒì—°ë½ì²˜
      params.parentPhone || '',        // E: ë¶€ëª¨ë‹˜ì—°ë½ì²˜
      params.highSchool || '',         // F: ì¶œì‹ ê³ ë“±í•™êµ
      params.startDate || '',          // G: í¬ë§ë“±ì›ì¼
      params.suneungScore || '',       // H: ìˆ˜ëŠ¥ë“±ê¸‰
      params.preRegister7f || params.preRegister || '',  // I: ì‚¬ì „ë“±ë¡í¬ë§
      params.paymentMethod || '',      // J: ê²°ì œë°©ë²•
      params.smoking7f || params.smoking || ''  // K: í¡ì—°ì—¬ë¶€
    ]);
    
    // ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
    sendEmailNotification('7ì¸µ Nìˆ˜ìƒ(ë…í•™ì¬ìˆ˜)', params);
    
    return { success: true, message: 'ëŒ€ê¸° ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' };
  } catch (error) {
    return { success: false, message: error.toString() };
  }
}

// =====================================================
// ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
// =====================================================
function sendEmailNotification(type, params) {
  const recipient = 'englishlove560@gmail.com';
  const subject = `[ê¹€ì—„ë§ˆì†¡ë„] ìƒˆë¡œìš´ ${type} ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!`;
  
  let body = `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ ìƒˆë¡œìš´ ${type} ì‹ ì²­ ì•Œë¦¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â° ì‹ ì²­ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}

`;

  if (type === 'ë ˆë²¨í…ŒìŠ¤íŠ¸') {
    body += `
ğŸ‘¤ í•™ìƒì •ë³´
- ì´ë¦„: ${params.studentName || '-'}
- ì„±ë³„: ${params.gender || '-'}
- í•™êµ: ${params.school || '-'}
- í•™ë…„: ${params.grade || '-'}

ğŸ“ ì—°ë½ì²˜
- í•™ìƒ: ${params.studentPhone || '-'}
- ë¶€ëª¨ë‹˜: ${params.parentPhone || '-'}

ğŸ“… í¬ë§ ìƒë‹´ì¼ì‹œ: ${params.consultDate || '-'}
ğŸ“Š ì˜ì–´ ìˆ˜ì¤€: ${params.englishLevel || '-'}
ğŸ¯ ê´€ì‹¬ í”„ë¡œê·¸ë¨: ${params.programs || '-'}
ğŸ’³ ê²°ì œ ë°©ë²•: ${params.paymentMethod || '-'}

ğŸ’¬ ë¬¸ì˜ì‚¬í•­:
${params.inquiry || 'ì—†ìŒ'}
`;
  } else if (type === '8ì¸µ ì¬í•™ìƒ(ë…ì„œì‹¤)') {
    body += `
ğŸ‘¤ í•™ìƒì •ë³´
- ì´ë¦„: ${params.studentName || '-'}
- ì„±ë³„: ${params.gender || '-'}
- í•™êµ: ${params.school || '-'}
- í•™ë…„: ${params.grade || '-'}

ğŸ“ ì—°ë½ì²˜
- í•™ìƒ: ${params.studentPhone || '-'}
- ë¶€ëª¨ë‹˜: ${params.parentPhone || '-'}

ğŸ“… í¬ë§ë“±ì›ì¼: ${params.startDate || '-'}
ğŸ“Š ë‚´ì‹ ë“±ê¸‰: ${params.gradeScore || '-'}
âœ… ì‚¬ì „ë“±ë¡í¬ë§: ${params.preRegister || '-'}
ğŸ’³ ê²°ì œë°©ë²•: ${params.paymentMethod || '-'}
ğŸš­ í¡ì—°ì—¬ë¶€í™•ì¸: ${params.smoking8f || params.smoking || '-'}
`;
  } else if (type === '7ì¸µ Nìˆ˜ìƒ(ë…í•™ì¬ìˆ˜)') {
    body += `
ğŸ‘¤ í•™ìƒì •ë³´
- ì´ë¦„: ${params.studentName || '-'}
- ì„±ë³„: ${params.gender || '-'}
- ì¶œì‹ ê³ ë“±í•™êµ: ${params.highSchool || '-'}

ğŸ“ ì—°ë½ì²˜
- í•™ìƒ: ${params.studentPhone || '-'}
- ë¶€ëª¨ë‹˜: ${params.parentPhone || '-'}

ğŸ“… í¬ë§ë“±ì›ì¼: ${params.startDate || '-'}
ğŸ“Š ìˆ˜ëŠ¥ë“±ê¸‰: ${params.suneungScore || '-'}
âœ… ì‚¬ì „ë“±ë¡í¬ë§: ${params.preRegister7f || params.preRegister || '-'}
ğŸ’³ ê²°ì œë°©ë²•: ${params.paymentMethod || '-'}
ğŸš­ í¡ì—°ì—¬ë¶€í™•ì¸: ${params.smoking7f || params.smoking || '-'}
`;
  }

  body += `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”— ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ í™•ì¸í•˜ì„¸ìš”
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;

  try {
    MailApp.sendEmail(recipient, subject, body);
  } catch (error) {
    console.log('ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ' + error.toString());
  }
}

// =====================================================
// ì´ˆê¸° ì„¤ì • í•¨ìˆ˜ (ìµœì´ˆ 1íšŒ ì‹¤í–‰)
// =====================================================
function setupSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // users ì‹œíŠ¸
  let users = ss.getSheetByName('users');
  if (!users) {
    users = ss.insertSheet('users');
    users.appendRow(['username', 'password', 'name', 'grade', 'school', 'parentPhone', 'studentPhone', 'level', 'is_admin', 'created_at', 'status']);
  }
  
  // progress ì‹œíŠ¸
  let progress = ss.getSheetByName('progress');
  if (!progress) {
    progress = ss.insertSheet('progress');
    progress.appendRow(['username', 'book_title', 'chapter', 'completed', 'score', 'completed_at']);
  }
  
  // leveltest ì‹œíŠ¸ (ì–´í•™ì› ë ˆë²¨í…ŒìŠ¤íŠ¸)
  let leveltest = ss.getSheetByName('leveltest');
  if (!leveltest) {
    leveltest = ss.insertSheet('leveltest');
    leveltest.appendRow(['ì‹ ì²­ì¼ì‹œ', 'í•™ìƒì´ë¦„', 'ì„±ë³„', 'í•™ìƒì—°ë½ì²˜', 'ë¶€ëª¨ë‹˜ì—°ë½ì²˜', 'í•™êµ', 'í•™ë…„', 'í¬ë§ìƒë‹´ì¼ì‹œ', 'ê´€ì‹¬í”„ë¡œê·¸ë¨', 'ì˜ì–´ìˆ˜ì¤€', 'ë¬¸ì˜ì‚¬í•­', 'ê²°ì œë°©ë²•', 'í™•ì¸ìƒíƒœ']);
  }
  
  // student8f ì‹œíŠ¸ (8ì¸µ ì¬í•™ìƒ)
  let student8f = ss.getSheetByName('student8f');
  if (!student8f) {
    student8f = ss.insertSheet('student8f');
    student8f.appendRow(['ì‹ ì²­ì¼ì‹œ', 'í•™ìƒì´ë¦„', 'ì„±ë³„', 'í•™ìƒì—°ë½ì²˜', 'ë¶€ëª¨ë‹˜ì—°ë½ì²˜', 'í•™êµ', 'í•™ë…„', 'í¬ë§ë“±ì›ì¼', 'ë‚´ì‹ ë“±ê¸‰', 'ì‚¬ì „ë“±ë¡í¬ë§', 'ê²°ì œë°©ë²•', 'í¡ì—°ì—¬ë¶€']);
  }
  
  // nsu7f ì‹œíŠ¸ (7ì¸µ Nìˆ˜ìƒ)
  let nsu7f = ss.getSheetByName('nsu7f');
  if (!nsu7f) {
    nsu7f = ss.insertSheet('nsu7f');
    nsu7f.appendRow(['ì‹ ì²­ì¼ì‹œ', 'í•™ìƒì´ë¦„', 'ì„±ë³„', 'í•™ìƒì—°ë½ì²˜', 'ë¶€ëª¨ë‹˜ì—°ë½ì²˜', 'ì¶œì‹ ê³ ë“±í•™êµ', 'í¬ë§ë“±ì›ì¼', 'ìˆ˜ëŠ¥ë“±ê¸‰', 'ì‚¬ì „ë“±ë¡í¬ë§', 'ê²°ì œë°©ë²•', 'í¡ì—°ì—¬ë¶€']);
  }
  
  return 'ëª¨ë“  ì‹œíŠ¸ ì„¤ì • ì™„ë£Œ!';
}
